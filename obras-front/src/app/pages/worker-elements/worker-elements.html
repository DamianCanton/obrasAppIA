<p-toast></p-toast>

<div class="flex flex-column gap-4">
  <div class="surface-card shadow-2 border-round-2xl p-4 lg:p-5">
    <div class="flex flex-column lg:flex-row lg:align-items-center lg:justify-content-between gap-4">
      <div class="flex flex-column gap-2">
        <h2 class="text-2xl font-semibold text-900 m-0">Elementos disponibles</h2>
        <p class="text-sm text-600 m-0">
          Consulta el stock del deposito y agrega lo que necesites a tu inventario personal.
        </p>
      </div>

      <div class="filters flex flex-column sm:flex-row gap-3 w-full lg:w-auto">
        <p-dropdown
          [options]="categories"
          [(ngModel)]="categoryFilterValue"
          optionLabel="label"
          optionValue="value"
          (onChange)="onCategoryChange($event.value)"
          styleClass="w-full sm:w-14rem"
          placeholder="Filtrar por categoria"
        ></p-dropdown>

        <span class="p-input-icon-left flex-1">
          <i class="pi pi-search"></i>
          <input
            #searchInput
            pInputText
            type="text"
            class="w-full"
            placeholder="Buscar elemento..."
            (input)="onSearch(searchInput.value)"
          />
        </span>

        <button
          pButton
          type="button"
          icon="pi pi-refresh"
          label="Actualizar"
          severity="secondary"
          class="w-full sm:w-auto"
          (click)="refresh()"
          [loading]="loading()"
        ></button>
      </div>
    </div>
  </div>

  <div class="surface-card shadow-2 border-round-2xl overflow-hidden">
    <p-table
      [value]="filteredElements()"
      dataKey="id"
      [loading]="loading()"
      responsiveLayout="scroll"
      styleClass="w-full"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Nombre</th>
          <th class="hide-xs">Categoria</th>
          <th>Estado</th>
          <th class="actions-column">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-element>
        <tr>
          <td>
            <div class="flex flex-column gap-1">
              <span class="font-medium text-900">{{ element.name }}</span>
              <small class="text-600 text-sm truncate" [title]="element.brand" *ngIf="element.brand">
                {{ element.brand }}
              </small>
            </div>
          </td>
          <td class="hide-xs">
            {{ element.category?.name || 'Sin categoria' }}
          </td>
          <td>
            <p-tag
              *ngIf="element.isAssigned"
              [severity]="element.isAssignedToCurrentWorker ? 'warn' : 'danger'"
              [value]="
                element.isAssignedToCurrentWorker
                  ? 'En tu inventario'
                  : 'Asignado a ' + (element.activeAssignment?.worker?.name || 'otro obrero')
              "
            />
            <p-tag *ngIf="!element.isAssigned" severity="success" value="Disponible" />
          </td>
          <td class="actions-column">
            <button
              pButton
              type="button"
              icon="pi pi-plus"
              label="Agregar"
              severity="warn"
              [disabled]="isAssignDisabled(element)"
              [loading]="assigning() === element.id"
              (click)="assign(element)"
              pTooltip="Agregar a mi inventario"
              tooltipPosition="top"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="4" class="text-center py-5 text-600">
            No encontramos elementos con los filtros seleccionados.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
